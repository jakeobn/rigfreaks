{% extends 'chillblast_layout.html' %}

{% block title %}Build Your PC - Step-by-Step Builder - RigFreaks{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chillblast-builder.css') }}">
{% endblock %}

{% block content %}
<div class="builder-container">
    <div class="container">
        <!-- Builder Header -->
        <div class="builder-header">
            <h1 class="builder-title">Custom PC Builder</h1>
            <p class="builder-subtitle">Follow our step-by-step process to select the perfect components for your custom PC.</p>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                {% set steps = [('cpu', 'CPU'), ('motherboard', 'Motherboard'), ('ram', 'Memory'), ('gpu', 'Graphics'), 
                              ('storage', 'Storage'), ('power_supply', 'Power'), ('case', 'Case'), ('cooling', 'Cooling')] %}
                
                {% for step_id, step_name in steps %}
                    {% set is_active = current_step == step_id %}
                    {% set is_completed = step_id in current_config %}
                    {% set step_index = loop.index %}
                    
                    <div class="step-item {% if is_active %}active{% elif is_completed %}completed{% endif %}">
                        <div class="step-circle">
                            {% if is_completed and not is_active %}
                                <i class="fas fa-check"></i>
                            {% else %}
                                {{ step_index }}
                            {% endif %}
                        </div>
                        <div class="step-label">{{ step_name }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Component Selection -->
        <div class="component-section">
            <div class="section-header">
                <h2 class="section-title">
                    {% set icons = {
                        'cpu': 'fas fa-microchip',
                        'motherboard': 'fas fa-server',
                        'ram': 'fas fa-memory',
                        'gpu': 'fas fa-tv',
                        'storage': 'fas fa-hdd',
                        'power_supply': 'fas fa-bolt',
                        'case': 'fas fa-desktop',
                        'cooling': 'fas fa-wind'
                    } %}
                    
                    {% set titles = {
                        'cpu': 'Select Processor',
                        'motherboard': 'Select Motherboard',
                        'ram': 'Select Memory',
                        'gpu': 'Select Graphics Card',
                        'storage': 'Select Storage',
                        'power_supply': 'Select Power Supply',
                        'case': 'Select Case',
                        'cooling': 'Select Cooling'
                    } %}
                    
                    <div class="section-icon">
                        <i class="{{ icons[current_step] }}"></i>
                    </div>
                    {{ titles[current_step] }}
                </h2>
                
                <div class="filter-controls">
                    <select class="filter-control" id="filter-brand">
                        <option value="">All Brands</option>
                        {% set brands = [] %}
                        {% for component in components[current_step] %}
                            {% if component.brand and component.brand not in brands %}
                                {% set _ = brands.append(component.brand) %}
                                <option value="{{ component.brand }}">{{ component.brand }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    
                    <select class="filter-control" id="filter-sort">
                        <option value="recommended">Recommended</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="name-asc">Name: A to Z</option>
                        <option value="name-desc">Name: Z to A</option>
                    </select>
                </div>
            </div>
            
            <!-- Component Cards Grid -->
            <div class="component-grid" id="component-grid">
                {% for component in components[current_step] %}
                <div class="component-card {% if current_config.get(current_step) == component.id %}selected{% endif %}" data-brand="{{ component.brand }}" data-price="{{ component.price }}" data-name="{{ component.name }}">
                    <div class="card-header">
                        <h3 class="component-name">{{ component.name }}</h3>
                    </div>
                    <div class="card-body">
                        {% if component.image %}
                        <img src="{{ component.image }}" alt="{{ component.name }}" class="component-img">
                        {% else %}
                        <div class="component-img-placeholder"></div>
                        {% endif %}
                        <div class="component-specs">{{ component.description | truncate(150) }}</div>
                    </div>
                    <div class="card-footer">
                        <div class="component-price">£{{ component.price }}</div>
                        <form action="{{ url_for('add_component', category=current_step, component_id=component.id) }}" method="post">
                            <button type="submit" class="btn-select {% if current_config.get(current_step) == component.id %}selected{% endif %}">
                                {% if current_config.get(current_step) == component.id %}
                                Selected
                                {% else %}
                                Select
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Current Build Summary -->
            <div class="current-build">
                <h3 class="current-build-title"><i class="fas fa-cogs"></i> Current Configuration</h3>
                
                <div class="current-components">
                    {% for step_id, step_name in steps %}
                        {% if step_id in current_config %}
                            {% set component_id = current_config[step_id] %}
                            {% set component = namespace(found=None) %}
                            {% for comp in components[step_id] %}
                                {% if comp.id == component_id %}
                                    {% set component.found = comp %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if component.found %}
                                <div class="current-component">
                                    <div class="component-category">{{ step_name }}</div>
                                    <div class="selected-component">{{ component.found.name }}</div>
                                    <div class="component-cost">£{{ component.found.price }}</div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="current-component" style="opacity: 0.5;">
                                <div class="component-category">{{ step_name }}</div>
                                <div class="selected-component">Not Selected</div>
                                <div class="component-cost">£0.00</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div class="current-build-footer">
                    <div class="build-actions">
                        <form action="{{ url_for('reset_configuration') }}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash-alt me-1"></i>Clear Build
                            </button>
                        </form>
                    </div>
                    
                    <div class="total-price">
                        <span class="total-price-label">Total:</span>
                        <span class="total-price-value">£{{ '%0.2f' | format(total_price) }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Compatibility Warnings -->
            {% if compatibility_issues %}
            <div class="compatibility-notice">
                <div class="compatibility-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="compatibility-content">
                    <h4>Compatibility Issues Detected</h4>
                    <ul>
                        {% for issue in compatibility_issues %}
                        <li>{{ issue }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Navigation Buttons -->
        <div class="builder-nav">
            {% if prev_step %}
            <a href="{{ url_for('select_component', category=prev_step) }}" class="btn-prev">
                <i class="fas fa-chevron-left"></i> Previous: {{ steps | selectattr('0', 'equalto', prev_step) | map(attribute=1) | first }}
            </a>
            {% else %}
            <div></div>
            {% endif %}
            
            {% if next_step %}
            <a href="{{ url_for('select_component', category=next_step) }}" class="btn-next">
                Next: {{ steps | selectattr('0', 'equalto', next_step) | map(attribute=1) | first }} <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <a href="{{ url_for('summary') }}" class="btn-summary">
                Review Configuration <i class="fas fa-check-circle"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter and sorting functionality
        const filterBrand = document.getElementById('filter-brand');
        const filterSort = document.getElementById('filter-sort');
        const componentGrid = document.getElementById('component-grid');
        const componentCards = Array.from(document.querySelectorAll('.component-card'));
        
        function applyFilters() {
            const brandValue = filterBrand.value;
            const sortValue = filterSort.value;
            
            // Filter by brand
            componentCards.forEach(card => {
                if (brandValue === '' || card.dataset.brand === brandValue) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Sort components
            const visibleCards = componentCards.filter(card => card.style.display !== 'none');
            visibleCards.sort((a, b) => {
                switch (sortValue) {
                    case 'price-asc':
                        return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
                    case 'price-desc':
                        return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
                    case 'name-asc':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'name-desc':
                        return b.dataset.name.localeCompare(a.dataset.name);
                    default: // recommended
                        return 0; // Keep original order
                }
            });
            
            // Reappend cards in new order
            visibleCards.forEach(card => {
                componentGrid.appendChild(card);
            });
        }
        
        // Add event listeners for filters
        filterBrand.addEventListener('change', applyFilters);
        filterSort.addEventListener('change', applyFilters);
    });
</script>
{% endblock %}