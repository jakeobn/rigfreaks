{% extends 'layout.html' %}

{% block title %}PC Builder{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modern-builder.css') }}">
{% endblock %}

{% block content %}
<div class="builder-container py-4">
    <div class="container">
        <!-- Header Area -->
        <header class="text-center mb-5">
            <h1 class="text-white fw-bold builder-title mb-3">PC Builder</h1>
            <p class="text-white-50 fs-5 mb-4 mx-auto" style="max-width: 800px;">Build your dream PC by selecting high-quality components. We'll check compatibility automatically.</p>
        </header>
        
        <!-- Component Progress -->
        <div class="progress-tracker mb-5">
            <div class="progress-inner">
                {% set component_categories = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                {% for category in component_categories %}
                    <div class="progress-item {% if category in current_config %}complete{% elif loop.index0 == 0 and 'cpu' not in current_config %}active{% endif %}">
                        <div class="progress-icon">
                            <i class="fas fa-{% if category == 'cpu' %}microchip{% elif category == 'motherboard' %}server{% elif category == 'ram' %}memory{% elif category == 'gpu' %}tv{% elif category == 'storage' %}hdd{% elif category == 'power_supply' %}plug{% elif category == 'case' %}desktop{% elif category == 'cooling' %}wind{% endif %}"></i>
                        </div>
                        <div class="progress-label">{{ category|capitalize }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="row">
            <!-- Components Selection -->
            <div class="col-lg-8 pe-lg-4">
                <div class="components-section">
                    <h2 class="section-title mb-4">Select Components</h2>
                    
                    <div class="row g-4">
                        {% set component_categories = [
                            {'id': 'cpu', 'name': 'Processor', 'icon': 'microchip', 'desc': 'The brain of your PC'},
                            {'id': 'motherboard', 'name': 'Motherboard', 'icon': 'server', 'desc': 'Connects all components'},
                            {'id': 'ram', 'name': 'Memory', 'icon': 'memory', 'desc': 'Temporary storage for active tasks'},
                            {'id': 'gpu', 'name': 'Graphics Card', 'icon': 'tv', 'desc': 'Powers visuals and rendering'},
                            {'id': 'storage', 'name': 'Storage', 'icon': 'hdd', 'desc': 'Long-term data storage'},
                            {'id': 'power_supply', 'name': 'Power Supply', 'icon': 'plug', 'desc': 'Powers all components'},
                            {'id': 'case', 'name': 'Case', 'icon': 'desktop', 'desc': 'Houses all components'},
                            {'id': 'cooling', 'name': 'Cooling', 'icon': 'wind', 'desc': 'Keeps components cool'}
                        ] %}
                        
                        {% for category in component_categories %}
                        <div class="col-md-6 mb-4">
                            <div class="component-card {% if current_config.get(category.id) %}selected{% endif %}">
                                <div class="component-header">
                                    <div class="component-icon">
                                        <i class="fas fa-{{ category.icon }}"></i>
                                    </div>
                                    <div class="component-title">
                                        <h3>{{ category.name }}</h3>
                                        <p>{{ category.desc }}</p>
                                    </div>
                                </div>
                                
                                {% if current_config.get(category.id) %}
                                    {% set component = components[category.id] | selectattr('id', 'equalto', current_config[category.id]) | first %}
                                    <div class="component-body">
                                        <div class="selected-component">
                                            <h4 class="component-name">{{ component.name }}</h4>
                                            <p class="component-desc">{{ component.description }}</p>
                                            
                                            <div class="component-specs">
                                                {% if category.id == 'cpu' %}
                                                    <span class="spec-pill">{{ component.cores }} Cores</span>
                                                    <span class="spec-pill">{{ component.threads }} Threads</span>
                                                    <span class="spec-pill">{{ component.base_clock }}GHz</span>
                                                {% elif category.id == 'gpu' %}
                                                    <span class="spec-pill">{{ component.vram }}GB VRAM</span>
                                                    <span class="spec-pill">{{ component.memory_type }}</span>
                                                {% elif category.id == 'ram' %}
                                                    <span class="spec-pill">{{ component.capacity }}GB</span>
                                                    <span class="spec-pill">{{ component.speed }}MHz</span>
                                                    <span class="spec-pill">{{ component.type }}</span>
                                                {% elif category.id == 'storage' %}
                                                    <span class="spec-pill">{{ component.capacity }}GB</span>
                                                    <span class="spec-pill">{{ component.type }}</span>
                                                {% elif category.id == 'power_supply' %}
                                                    <span class="spec-pill">{{ component.wattage }}W</span>
                                                    <span class="spec-pill">{{ component.efficiency }}</span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="component-price">${{ component.price }}</div>
                                            
                                            <div class="component-actions">
                                                <a href="{{ url_for('component_detail', category=category.id, component_id=current_config[category.id]) }}" class="btn-details">
                                                    <i class="fas fa-info-circle"></i> Details
                                                </a>
                                                <button type="button" class="btn-change component-select-btn" data-category="{{ category.id }}">
                                                    <i class="fas fa-exchange-alt"></i> Change
                                                </button>
                                                <form action="{{ url_for('remove_component', category=category.id) }}" method="post" class="d-inline">
                                                    <button type="submit" class="btn-remove">
                                                        <i class="fas fa-trash-alt"></i> Remove
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="component-body empty">
                                        <div class="empty-state">
                                            <div class="empty-icon">
                                                <i class="fas fa-plus-circle"></i>
                                            </div>
                                            <h4>No {{ category.name }} Selected</h4>
                                            <p>Select a {{ category.name.lower() }} to complete your build</p>
                                            <button type="button" class="btn-add component-select-btn" data-category="{{ category.id }}">
                                                <i class="fas fa-plus-circle"></i> Select {{ category.name }}
                                            </button>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Build Summary -->
            <div class="col-lg-4">
                <div class="build-summary">
                    <h2 class="summary-title"><i class="fas fa-clipboard-list me-2"></i> Build Summary</h2>
                    <div class="completion-status">
                        <div class="progress">
                            {% set completion = (current_config|length / 8 * 100)|int %}
                            <div class="progress-bar" role="progressbar" style="width: {{ completion }}%;" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">{{ completion }}%</div>
                        </div>
                        <div class="status-text">
                            <span class="badge bg-primary">{{ current_config|length }}/8</span>
                            Components Selected
                        </div>
                    </div>
                    
                    {% if current_config %}
                        <div class="components-list">
                            {% for category in ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                                <div class="summary-item {% if category in current_config %}selected{% else %}missing{% endif %}">
                                    <div class="item-icon">
                                        <i class="fas fa-{% if category == 'cpu' %}microchip{% elif category == 'motherboard' %}server{% elif category == 'ram' %}memory{% elif category == 'gpu' %}tv{% elif category == 'storage' %}hdd{% elif category == 'power_supply' %}plug{% elif category == 'case' %}desktop{% elif category == 'cooling' %}wind{% endif %}"></i>
                                    </div>
                                    
                                    {% if category in current_config %}
                                        {% set component = components[category] | selectattr('id', 'equalto', current_config[category]) | first %}
                                        <div class="item-details">
                                            <h4>{{ component.name }}</h4>
                                            <p>{{ category|capitalize }}</p>
                                        </div>
                                        <div class="item-price">${{ component.price }}</div>
                                    {% else %}
                                        <div class="item-details missing">
                                            <h4>No {{ category|capitalize }}</h4>
                                            <p>Required component</p>
                                        </div>
                                        <button type="button" class="btn-select component-select-btn" data-category="{{ category }}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="price-summary">
                            <div class="subtotal">
                                <span>Components Subtotal:</span>
                                <span>${{ total_price }}</span>
                            </div>
                            <div class="total">
                                <span>Total Price:</span>
                                <span>${{ total_price }}</span>
                            </div>
                        </div>
                        
                        <div class="summary-actions">
                            {% set required_categories = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                            
                            {% set missing_count = namespace(value=0) %}
                            {% for category in required_categories %}
                                {% if category not in current_config %}
                                    {% set missing_count.value = missing_count.value + 1 %}
                                {% endif %}
                            {% endfor %}
                            
                            <a href="{{ url_for('summary') }}" class="btn-review">
                                <i class="fas fa-clipboard-check"></i> Review Configuration
                            </a>
                            
                            {% if missing_count.value == 0 %}
                                <form action="{{ url_for('cart.add_to_cart') }}" method="post">
                                    <button type="submit" class="btn-cart">
                                        <i class="fas fa-shopping-cart"></i> Add to Cart
                                    </button>
                                </form>
                            {% else %}
                                <button disabled class="btn-cart disabled">
                                    <i class="fas fa-lock"></i> Add to Cart
                                    <span class="cart-badge">{{ missing_count.value }} missing</span>
                                </button>
                                <div class="cart-note">
                                    <i class="fas fa-info-circle"></i>
                                    <div>
                                        <strong>Build incomplete</strong>
                                        <p>All required components must be selected</p>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <form action="{{ url_for('reset_configuration') }}" method="post">
                                <button type="submit" class="btn-reset">
                                    <i class="fas fa-trash-alt"></i> Reset Build
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="empty-summary">
                            <div class="empty-illustration">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <h3>Your Build is Empty</h3>
                            <p>Start by selecting components to build your custom PC</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Mobile Summary Button -->
                <div class="d-md-none d-block mobile-fab">
                    <button type="button" id="mobileSummaryBtn" class="btn-fab">
                        <i class="fas fa-clipboard-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Summary Panel -->
    <div id="mobileSummaryPanel" class="mobile-summary">
        <div class="drag-handle"></div>
        <div class="mobile-summary-header">
            <h3><i class="fas fa-clipboard-list me-2"></i> Build Summary</h3>
            <button type="button" id="closeMobileSummary" class="btn-close"></button>
        </div>
        
        <div class="mobile-summary-content">
            {% if current_config %}
                <div class="components-list">
                    {% for category in ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                        <div class="summary-item {% if category in current_config %}selected{% else %}missing{% endif %}">
                            <div class="item-icon">
                                <i class="fas fa-{% if category == 'cpu' %}microchip{% elif category == 'motherboard' %}server{% elif category == 'ram' %}memory{% elif category == 'gpu' %}tv{% elif category == 'storage' %}hdd{% elif category == 'power_supply' %}plug{% elif category == 'case' %}desktop{% elif category == 'cooling' %}wind{% endif %}"></i>
                            </div>
                            
                            {% if category in current_config %}
                                {% set component = components[category] | selectattr('id', 'equalto', current_config[category]) | first %}
                                <div class="item-details">
                                    <h4>{{ component.name }}</h4>
                                    <p>{{ category|capitalize }}</p>
                                </div>
                                <div class="item-price">${{ component.price }}</div>
                            {% else %}
                                <div class="item-details missing">
                                    <h4>No {{ category|capitalize }}</h4>
                                    <p>Required component</p>
                                </div>
                                <button type="button" class="btn-select component-select-btn" data-category="{{ category }}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="price-summary">
                    <div class="subtotal">
                        <span>Components Subtotal:</span>
                        <span>${{ total_price }}</span>
                    </div>
                    <div class="total">
                        <span>Total Price:</span>
                        <span>${{ total_price }}</span>
                    </div>
                </div>
                
                <div class="summary-actions">
                    {% set required_categories = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                    
                    {% set missing_count = namespace(value=0) %}
                    {% for category in required_categories %}
                        {% if category not in current_config %}
                            {% set missing_count.value = missing_count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    
                    <a href="{{ url_for('summary') }}" class="btn-review">
                        <i class="fas fa-clipboard-check"></i> Review Configuration
                    </a>
                    
                    {% if missing_count.value == 0 %}
                        <form action="{{ url_for('cart.add_to_cart') }}" method="post">
                            <button type="submit" class="btn-cart">
                                <i class="fas fa-shopping-cart"></i> Add to Cart
                            </button>
                        </form>
                    {% else %}
                        <button disabled class="btn-cart disabled">
                            <i class="fas fa-lock"></i> Add to Cart
                            <span class="cart-badge">{{ missing_count.value }} missing</span>
                        </button>
                        <div class="cart-note">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Build incomplete</strong>
                                <p>All required components must be selected</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <form action="{{ url_for('reset_configuration') }}" method="post">
                        <button type="submit" class="btn-reset">
                            <i class="fas fa-trash-alt"></i> Reset Build
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="empty-summary">
                    <div class="empty-illustration">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <h3>Your Build is Empty</h3>
                    <p>Start by selecting components to build your custom PC</p>
                </div>
            {% endif %}
        </div>
    </div>
    <div id="mobileSummaryBackdrop" class="mobile-backdrop"></div>
    
    <!-- Component Selection Modal -->
    <div id="componentSelectionBackdrop" class="component-modal-backdrop d-none"></div>
    <div id="componentSelectionContainer" class="component-modal-container d-none">
        <div class="component-modal">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <div class="modal-category-icon" id="modalCategoryIcon">
                        <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <div>
                        <h3 id="componentModalLabel">Select Component</h3>
                        <p id="modalCategoryDescription">Choose from compatible components</p>
                    </div>
                </div>
                <button type="button" id="closeComponentSelection" class="btn-close"></button>
            </div>
            
            <div class="modal-search">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="componentSearch" placeholder="Search components...">
                    <div class="filter-controls">
                        <div class="filter-pills">
                            <span class="filter-label">Filters:</span>
                            <div class="filter-pill active" data-filter="all">All</div>
                            <div class="filter-pill" data-filter="recommended">Recommended</div>
                            <div class="filter-pill" data-filter="premium">Premium</div>
                            <div class="filter-pill" data-filter="budget">Budget</div>
                        </div>
                        
                        <div class="sort-dropdown">
                            <button class="btn-sort dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-sort"></i> <span>Sort</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark">
                                <li><button class="dropdown-item sort-option" data-sort="name"><i class="fas fa-font text-light me-2"></i>Name</button></li>
                                <li><button class="dropdown-item sort-option" data-sort="price-asc"><i class="fas fa-arrow-up text-success me-2"></i>Price (Low to High)</button></li>
                                <li><button class="dropdown-item sort-option" data-sort="price-desc"><i class="fas fa-arrow-down text-danger me-2"></i>Price (High to Low)</button></li>
                                <li><button class="dropdown-item sort-option" data-sort="performance"><i class="fas fa-tachometer-alt text-primary me-2"></i>Performance</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-body">
                <div id="component-loading" class="loading-state">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Finding the best components for your build...</p>
                </div>
                
                <div id="componentCardsWrapper" class="component-grid"></div>
            </div>
            
            <div class="modal-footer">
                <div class="compatibility-note">
                    <i class="fas fa-info-circle"></i>
                    <span>Only compatible components shown</span>
                </div>
                
                <button type="button" id="cancelComponentSelection" class="btn-cancel">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Store component data globally to use in the modal
    const componentData = {{ components|tojson }};
    let currentCategory = '';
    let filteredComponents = [];
    
    // Category information and icons
    const categoryInfo = {
        'cpu': {
            icon: 'microchip',
            description: 'Central Processing Unit is the brain of your computer',
            performanceMetric: 'Processing Power'
        },
        'motherboard': {
            icon: 'server',
            description: 'Main circuit board that connects all components',
            performanceMetric: 'Features & Connectivity'
        },
        'ram': {
            icon: 'memory',
            description: 'Memory modules for temporary data storage',
            performanceMetric: 'Memory Speed'
        },
        'gpu': {
            icon: 'tv',
            description: 'Graphics Processing Unit for rendering visuals',
            performanceMetric: 'Graphics Performance'
        },
        'storage': {
            icon: 'hdd',
            description: 'Storage devices for your data and programs',
            performanceMetric: 'Read/Write Speed'
        },
        'power_supply': {
            icon: 'plug',
            description: 'Provides power to all PC components',
            performanceMetric: 'Power Efficiency'
        },
        'case': {
            icon: 'desktop',
            description: 'Enclosure that houses all PC components',
            performanceMetric: 'Airflow & Design'
        },
        'cooling': {
            icon: 'wind',
            description: 'Keeps components cool under load',
            performanceMetric: 'Cooling Capacity'
        }
    };
    
    // Function to create component cards
    function createComponentRows(components, category, currentConfig) {
        const cardContainer = document.getElementById('componentCardsWrapper');
        const loadingElement = document.getElementById('component-loading');
        
        // Show loading first
        if (loadingElement) loadingElement.style.display = 'flex';
        if (cardContainer) cardContainer.innerHTML = '';
        
        // Hide loading after small delay
        setTimeout(() => {
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (!cardContainer || !components || components.length === 0) {
                if (cardContainer) {
                    cardContainer.innerHTML = `
                        <div class="empty-results">
                            <i class="fas fa-search"></i>
                            <h3>No components found</h3>
                            <p>Try a different search term or category</p>
                        </div>
                    `;
                }
                return;
            }
            
            components.forEach(component => {
                // Parse current config
                const isSelected = currentConfig && currentConfig[category] === component.id;
                
                // Create the component card
                const componentCard = document.createElement('div');
                componentCard.className = `component-card ${isSelected ? 'selected' : ''}`;
                
                componentCard.innerHTML = `
                    <div class="component-header">
                        <div class="component-title">
                            <h3>${component.name}</h3>
                            <p>${component.brand || ''}</p>
                        </div>
                        ${isSelected ? '<div class="selected-badge"><i class="fas fa-check"></i> Selected</div>' : ''}
                    </div>
                    
                    <div class="component-body">
                        <p class="component-desc">${component.description || 'No description available'}</p>
                        
                        <div class="component-specs">
                            ${category === 'cpu' 
                                ? `<span class="spec-pill">${component.cores} Cores</span>
                                   <span class="spec-pill">${component.threads} Threads</span>
                                   <span class="spec-pill">${component.base_clock}GHz</span>`
                                : ''}
                            ${category === 'gpu' 
                                ? `<span class="spec-pill">${component.vram}GB VRAM</span>
                                   <span class="spec-pill">${component.memory_type}</span>` 
                                : ''}
                            ${category === 'ram' 
                                ? `<span class="spec-pill">${component.capacity}GB</span>
                                   <span class="spec-pill">${component.speed}MHz</span>`
                                : ''}
                            ${category === 'storage' 
                                ? `<span class="spec-pill">${component.capacity}GB</span>
                                   <span class="spec-pill">${component.type}</span>`
                                : ''}
                            ${category === 'power_supply' 
                                ? `<span class="spec-pill">${component.wattage}W</span>
                                   <span class="spec-pill">${component.efficiency}</span>`
                                : ''}
                        </div>
                    </div>
                    
                    <div class="component-footer">
                        <div class="component-price">$${component.price}</div>
                        <form action="${isSelected 
                            ? '/builder/remove_component/${category}' 
                            : '/builder/add_component/${category}/${component.id}'}" 
                              method="POST">
                            <button type="submit" class="${isSelected ? 'btn-remove' : 'btn-add'}">
                                ${isSelected 
                                    ? '<i class="fas fa-times"></i> Remove' 
                                    : '<i class="fas fa-plus"></i> Select'}
                            </button>
                        </form>
                    </div>
                `;
                
                cardContainer.appendChild(componentCard);
            });
        }, 300);
    }
    
    // Document ready
    document.addEventListener('DOMContentLoaded', function() {
        // Set up component selection triggers
        const selectButtons = document.querySelectorAll('.component-select-btn');
        selectButtons.forEach(button => {
            if (button) {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    if (!category) return;
                    
                    currentCategory = category;
                    
                    // Update modal
                    const backdrop = document.getElementById('componentSelectionBackdrop');
                    const container = document.getElementById('componentSelectionContainer');
                    const modalLabel = document.getElementById('componentModalLabel');
                    const modalDescription = document.getElementById('modalCategoryDescription');
                    const modalIcon = document.getElementById('modalCategoryIcon').querySelector('i');
                    
                    if (backdrop) backdrop.classList.remove('d-none');
                    if (container) container.classList.remove('d-none');
                    
                    if (modalLabel) modalLabel.textContent = `Select ${category.charAt(0).toUpperCase() + category.slice(1)}`;
                    if (modalDescription && categoryInfo[category]) {
                        modalDescription.textContent = categoryInfo[category].description;
                    }
                    if (modalIcon && categoryInfo[category]) {
                        modalIcon.className = `fas fa-${categoryInfo[category].icon}`;
                    }
                    
                    // Load components
                    filterAndSortComponents();
                });
            }
        });
        
        // Set up component search
        const componentSearchInput = document.getElementById('componentSearch');
        if (componentSearchInput) {
            componentSearchInput.addEventListener('input', function() {
                filterAndSortComponents();
            });
        }
        
        // Set up filter pills
        const filterPills = document.querySelectorAll('.filter-pill');
        filterPills.forEach(pill => {
            if (pill) {
                pill.addEventListener('click', function() {
                    // Remove active class from all pills
                    filterPills.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked pill
                    this.classList.add('active');
                    
                    // Apply filtering
                    filterAndSortComponents();
                });
            }
        });
        
        // Function to combine all the search and filter logic
        function filterAndSortComponents() {
            const searchTerm = componentSearchInput ? componentSearchInput.value.toLowerCase() : '';
            
            // Filter components by search term
            let filtered = componentData[currentCategory] || [];
            
            // Get the active filter
            const activeFilter = document.querySelector('.filter-pill.active');
            const filterType = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
            
            // Apply text search
            if (searchTerm) {
                filtered = filtered.filter(component => {
                    return component.name.toLowerCase().includes(searchTerm) ||
                           (component.description && component.description.toLowerCase().includes(searchTerm)) ||
                           (component.brand && component.brand.toLowerCase().includes(searchTerm));
                });
            }
            
            // Apply category filter (if not 'all')
            if (filterType && filterType !== 'all') {
                if (filterType === 'recommended') {
                    // Filter for mid-range components (middle 50% by price)
                    const sortedByPrice = [...filtered].sort((a, b) => a.price - b.price);
                    const quarterIndex = Math.floor(sortedByPrice.length / 4);
                    const lowerIndex = quarterIndex;
                    const upperIndex = sortedByPrice.length - quarterIndex;
                    
                    filtered = sortedByPrice.slice(lowerIndex, upperIndex);
                } else if (filterType === 'premium') {
                    // Filter for high-end components (top 33% by price)
                    const sortedByPrice = [...filtered].sort((a, b) => b.price - a.price);
                    const thirdIndex = Math.ceil(sortedByPrice.length / 3);
                    
                    filtered = sortedByPrice.slice(0, thirdIndex);
                } else if (filterType === 'budget') {
                    // Filter for budget components (bottom 33% by price)
                    const sortedByPrice = [...filtered].sort((a, b) => a.price - b.price);
                    const thirdIndex = Math.ceil(sortedByPrice.length / 3);
                    
                    filtered = sortedByPrice.slice(0, thirdIndex);
                }
            }
            
            filteredComponents = filtered;
            
            // Create component rows with the filtered data
            if (currentCategory) {
                createComponentRows(filteredComponents, currentCategory, {{ current_config|tojson }});
            }
        }
        
        // Close component selection modal
        const closeComponentSelection = document.getElementById('closeComponentSelection');
        const cancelComponentSelection = document.getElementById('cancelComponentSelection');
        const componentSelectionBackdrop = document.getElementById('componentSelectionBackdrop');
        
        function closeComponentModal() {
            const backdrop = document.getElementById('componentSelectionBackdrop');
            const container = document.getElementById('componentSelectionContainer');
            
            if (backdrop) backdrop.classList.add('d-none');
            if (container) container.classList.add('d-none');
        }
        
        if (closeComponentSelection) {
            closeComponentSelection.addEventListener('click', closeComponentModal);
        }
        
        if (cancelComponentSelection) {
            cancelComponentSelection.addEventListener('click', closeComponentModal);
        }
        
        if (componentSelectionBackdrop) {
            componentSelectionBackdrop.addEventListener('click', closeComponentModal);
        }
        
        // Sort options
        const sortOptions = document.querySelectorAll('.sort-option');
        sortOptions.forEach(option => {
            if (option) {
                option.addEventListener('click', function() {
                    const sortBy = this.getAttribute('data-sort');
                    
                    if (filteredComponents.length > 0) {
                        if (sortBy === 'name') {
                            filteredComponents.sort((a, b) => a.name.localeCompare(b.name));
                        } else if (sortBy === 'price-asc') {
                            filteredComponents.sort((a, b) => a.price - b.price);
                        } else if (sortBy === 'price-desc') {
                            filteredComponents.sort((a, b) => b.price - a.price);
                        } else if (sortBy === 'performance') {
                            // Sort by performance score if available
                            filteredComponents.sort((a, b) => (b.performance_score || 0) - (a.performance_score || 0));
                        }
                        
                        createComponentRows(filteredComponents, currentCategory, {{ current_config|tojson }});
                    }
                });
            }
        });
        
        // Mobile Summary Panel
        const mobileSummaryBtn = document.getElementById('mobileSummaryBtn');
        const mobileSummaryPanel = document.getElementById('mobileSummaryPanel');
        const mobileSummaryBackdrop = document.getElementById('mobileSummaryBackdrop');
        const closeMobileSummary = document.getElementById('closeMobileSummary');
        
        // Function to close the mobile summary panel
        function closeMobileSummaryPanel() {
            if (mobileSummaryPanel) mobileSummaryPanel.classList.remove('active');
            if (mobileSummaryBackdrop) mobileSummaryBackdrop.classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        // Mobile button click
        if (mobileSummaryBtn && mobileSummaryPanel) {
            mobileSummaryBtn.addEventListener('click', function() {
                mobileSummaryPanel.classList.add('active');
                if (mobileSummaryBackdrop) mobileSummaryBackdrop.classList.add('active');
                document.body.classList.add('modal-open');
            });
        }
        
        // Close button click
        if (closeMobileSummary) {
            closeMobileSummary.addEventListener('click', closeMobileSummaryPanel);
        }
        
        // Backdrop click
        if (mobileSummaryBackdrop) {
            mobileSummaryBackdrop.addEventListener('click', closeMobileSummaryPanel);
        }
        
        // Swipe to close
        if (mobileSummaryPanel) {
            let touchStartY = 0;
            let touchEndY = 0;
            
            mobileSummaryPanel.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
            });
            
            mobileSummaryPanel.addEventListener('touchmove', function(e) {
                touchEndY = e.touches[0].clientY;
            });
            
            mobileSummaryPanel.addEventListener('touchend', function() {
                if (touchEndY - touchStartY > 70) { // Swipe down threshold
                    closeMobileSummaryPanel();
                }
            });
        }
    });
</script>
{% endblock %}