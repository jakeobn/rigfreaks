{% extends 'layout.html' %}

{% block title %}PC Builder{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">PC Builder</h1>
    
    <!-- Component Selection Modal -->
    <div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="componentModalLabel">Select Component</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="componentTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Specs</th>
                                    <th>Price</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Component rows will be injected here via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Component Selection Progress -->
    <div class="row mb-4 build-progress">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        {% set component_categories = ['cpu', 'motherboard', 'ram', 'gpu', 'storage', 'power_supply', 'case', 'cooling'] %}
                        {% for category in component_categories %}
                            <div class="col build-progress-item {% if category in current_config %}completed{% endif %}">
                                <div class="build-progress-icon">
                                    {% if category == 'cpu' %}
                                        <i class="fas fa-microchip"></i>
                                    {% elif category == 'motherboard' %}
                                        <i class="fas fa-server"></i>
                                    {% elif category == 'ram' %}
                                        <i class="fas fa-memory"></i>
                                    {% elif category == 'gpu' %}
                                        <i class="fas fa-tv"></i>
                                    {% elif category == 'storage' %}
                                        <i class="fas fa-hdd"></i>
                                    {% elif category == 'power_supply' %}
                                        <i class="fas fa-plug"></i>
                                    {% elif category == 'case' %}
                                        <i class="fas fa-desktop"></i>
                                    {% elif category == 'cooling' %}
                                        <i class="fas fa-wind"></i>
                                    {% endif %}
                                </div>
                                <div class="build-progress-text">
                                    {{ category|capitalize }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Compatibility Issues Alert -->
    {% if compatibility_issues %}
    <div class="alert alert-warning">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Compatibility Issues</h4>
        <p>The following issues were detected with your current configuration:</p>
        <ul>
            {% for issue in compatibility_issues %}
            <li>{{ issue }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Component Selection -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Select Components</h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Choose components for your PC build. Make sure to select compatible parts for the best performance.</p>
                    
                    <!-- Component Categories -->
                    <div class="row g-4">
                        {% set component_categories = [
                            {'id': 'cpu', 'name': 'Processor', 'icon': 'microchip'},
                            {'id': 'motherboard', 'name': 'Motherboard', 'icon': 'server'},
                            {'id': 'ram', 'name': 'Memory', 'icon': 'memory'},
                            {'id': 'gpu', 'name': 'Graphics Card', 'icon': 'tv'},
                            {'id': 'storage', 'name': 'Storage', 'icon': 'hdd'},
                            {'id': 'power_supply', 'name': 'Power Supply', 'icon': 'plug'},
                            {'id': 'case', 'name': 'Case', 'icon': 'desktop'},
                            {'id': 'cooling', 'name': 'Cooling', 'icon': 'wind'}
                        ] %}
                        
                        {% for category in component_categories %}
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="bg-primary rounded p-2 me-3">
                                            <i class="fas fa-{{ category.icon }} text-white"></i>
                                        </div>
                                        <h5 class="mb-0">{{ category.name }}</h5>
                                    </div>
                                    
                                    {% if current_config.get(category.id) %}
                                        {% set component = components[category.id] | selectattr('id', 'equalto', current_config[category.id]) | first %}
                                        <div class="selected-component mb-3">
                                            <h6>{{ component.name }}</h6>
                                            <div class="d-flex justify-content-between">
                                                <span class="text-muted small">{{ component.description }}</span>
                                                <span class="text-success">${{ component.price }}</span>
                                            </div>
                                        </div>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between mb-2">
                                                <a href="{{ url_for('component_detail', category=category.id, component_id=current_config[category.id]) }}" class="btn btn-outline-primary btn-sm details-btn">
                                                    <i class="fas fa-info-circle me-1"></i>Details
                                                </a>
                                                <form action="{{ url_for('remove_component', category=category.id) }}" method="post">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                                        <i class="fas fa-trash-alt me-1"></i>Remove
                                                    </button>
                                                </form>
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary btn-sm w-100 component-dropdown-btn" data-category="{{ category.id }}">
                                                <i class="fas fa-exchange-alt me-1"></i>Change
                                            </button>
                                        </div>
                                    {% else %}
                                        <p class="text-muted small mb-3">No {{ category.name }} selected.</p>
                                        <div class="mt-auto">
                                            <button type="button" class="btn btn-primary btn-sm w-100 component-dropdown-btn add-component-btn" data-category="{{ category.id }}">
                                                <i class="fas fa-plus me-1"></i><span class="btn-text">Add {{ category.name }}</span>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Build Summary -->
        <div class="col-lg-4">
            <div class="card mb-4 position-sticky" style="top: 1rem;">
                <div class="card-header">
                    <h3 class="mb-0">Build Summary</h3>
                </div>
                <div class="card-body">
                    {% if current_config %}
                        {% for category, component_id in current_config.items() %}
                            {% set component = components[category] | selectattr('id', 'equalto', component_id) | first %}
                            <div class="selected-component-details mb-3">
                                <div class="selected-component-name">{{ component.name }}</div>
                                <div class="selected-component-price">${{ component.price }}</div>
                            </div>
                        {% endfor %}
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Total Price:</h5>
                            <div class="price-total">${{ total_price }}</div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <a href="{{ url_for('summary') }}" class="btn btn-success">
                                <i class="fas fa-check-circle me-1"></i>Review Build
                            </a>
                            <form action="{{ url_for('reset_configuration') }}" method="post">
                                <button type="submit" class="btn btn-outline-danger w-100">
                                    <i class="fas fa-trash-alt me-1"></i>Reset Configuration
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <h5>No Components Selected</h5>
                            <p>Your build is empty. Start by adding components from the left.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Compatibility Check -->
            <div id="compatibility-alert" class="mt-3" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Store component data globally to use in the modal
    const componentData = {{ components|tojson }};
    let currentCategory = '';
    
    // When the component dropdown button is clicked
    document.querySelectorAll('.component-dropdown-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get the category from the data attribute
            currentCategory = this.getAttribute('data-category');
            
            // Set the modal title
            document.getElementById('componentModalLabel').textContent = `Select ${currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1)}`;
            
            // Clear previous component rows
            const tableBody = document.getElementById('componentTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            // Show loading animation
            const loadingRow = document.createElement('tr');
            const loadingCell = document.createElement('td');
            loadingCell.setAttribute('colspan', '5');
            loadingCell.classList.add('text-center', 'py-5');
            
            // Create loading spinner
            loadingCell.innerHTML = `
                <div class="loading-animation">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading ${currentCategory} components...</p>
                </div>
            `;
            
            loadingRow.appendChild(loadingCell);
            tableBody.appendChild(loadingRow);
            
            // Show the modal
            const componentModal = new bootstrap.Modal(document.getElementById('componentModal'));
            componentModal.show();
            
            // Simulate loading delay (remove in production)
            setTimeout(() => {
                // Clear loading animation
                tableBody.innerHTML = '';
                
                // Add rows for each component in the selected category
                if (componentData[currentCategory]) {
                    componentData[currentCategory].forEach(component => {
                    const row = document.createElement('tr');
                    
                    // Highlight currently selected component
                    if ('{{ current_config|tojson }}' !== '{}') {
                        const currentConfig = JSON.parse('{{ current_config|tojson }}');
                        if (currentConfig[currentCategory] === component.id) {
                            row.classList.add('table-primary');
                        }
                    }
                    
                    // Component name with link to details
                    const nameCell = document.createElement('td');
                    nameCell.innerHTML = `<a href="/component/${currentCategory}/${component.id}" class="component-name"><strong>${component.name}</strong></a>`;
                    row.appendChild(nameCell);
                    
                    // Component description
                    const descCell = document.createElement('td');
                    descCell.textContent = component.description;
                    row.appendChild(descCell);
                    
                    // Component specs
                    const specsCell = document.createElement('td');
                    let specsList = '';
                    for (const [key, value] of Object.entries(component)) {
                        if (!['id', 'name', 'description', 'price', 'image_url', 'specs'].includes(key)) {
                            specsList += `<div><small><strong>${key.replace('_', ' ')}:</strong> ${value}</small></div>`;
                        }
                    }
                    specsCell.innerHTML = specsList;
                    row.appendChild(specsCell);
                    
                    // Component price
                    const priceCell = document.createElement('td');
                    priceCell.innerHTML = `<span class="text-success fw-bold">$${component.price}</span>`;
                    row.appendChild(priceCell);
                    
                    // Action buttons
                    const actionCell = document.createElement('td');
                    
                    // Create container for buttons
                    const btnGroup = document.createElement('div');
                    btnGroup.setAttribute('class', 'd-flex gap-2');
                    
                    // Details button
                    const detailsLink = document.createElement('a');
                    detailsLink.setAttribute('href', `/component/${currentCategory}/${component.id}`);
                    detailsLink.setAttribute('class', 'btn btn-outline-primary btn-sm details-btn');
                    detailsLink.innerHTML = '<i class="fas fa-info-circle me-1"></i>Details';
                    btnGroup.appendChild(detailsLink);
                    
                    // Select button
                    const selectForm = document.createElement('form');
                    selectForm.setAttribute('method', 'post');
                    selectForm.setAttribute('action', `/add/${currentCategory}/${component.id}`);
                    
                    const selectButton = document.createElement('button');
                    selectButton.setAttribute('type', 'submit');
                    selectButton.setAttribute('class', 'btn btn-primary btn-sm');
                    selectButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>Select';
                    
                    selectForm.appendChild(selectButton);
                    btnGroup.appendChild(selectForm);
                    
                    actionCell.appendChild(btnGroup);
                    row.appendChild(actionCell);
                    
                    tableBody.appendChild(row);
                });
            }
            }, 800); // 800ms delay to show the loading animation
        });
    });
    
    // Check compatibility when component is added
    document.getElementById('componentTable').addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM') {
            const componentId = e.target.getAttribute('action').split('/').pop();
            // You could add AJAX for compatibility check here if needed
        }
    });
</script>
{% endblock %}
